<!doctype html>
<html lang="fa">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Ù¾ÛŒØ§Ù†ÙˆÛŒ ÙˆØ¨ â€” Ù…Ø®ØµÙˆØµ Ø§Ù†Ø§Ù‡ÛŒØªØ§</title>
<style>
  :root{
    --white-key-width: 56px;
    --white-key-height: 300px;
    --black-key-width: 36px;
    --black-key-height: 180px;
    --gap: 2px;
    --accent: #ff6b81;
    --bg1: #071022;
    --bg2: #0f1724;
  }
  html,body{ height:100%; }
  body{
    font-family: "Vazirmatn", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin: 12px;
    background: linear-gradient(180deg,var(--bg2) 0%, var(--bg1) 100%);
    color: #eef6ff;
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items: center;
    min-height:100vh;
  }
  .notice{
    width:100%;
    max-width:1100px;
    background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    padding:14px;
    border-radius:12px;
    box-shadow: 0 6px 30px rgba(0,0,0,0.6);
    text-align:center;
  }
  .rotate{
    font-weight:700;
    font-size:16px;
    margin-bottom:6px;
  }
  .personal{
    font-size:15px;
    margin:6px 0;
  }
  .note-line{
    font-size:14px;
    opacity:0.95;
    display:flex;
    gap:8px;
    align-items:center;
    justify-content:center;
    flex-wrap:wrap;
  }
  .heart{
    width:34px;
    height:34px;
    display:inline-block;
    vertical-align:middle;
  }

  .controls{
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    width:100%;
    max-width:1100px;
    justify-content:center;
  }
  .controls label{ font-size:14px; display:flex; align-items:center; gap:8px; }

  .keyboard-wrap{
    overflow-x:auto;
    padding: 10px;
    width:100%;
    max-width:1100px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px;
    box-shadow: 0 6px 30px rgba(0,0,0,0.6);
  }

  .keyboard{
    position:relative;
    height:var(--white-key-height);
    user-select:none;
    touch-action: manipulation;
  }

  .key{
    position:absolute;
    box-sizing:border-box;
    border:1px solid rgba(0,0,0,0.2);
    display:flex;
    align-items:flex-end;
    justify-content:center;
    padding-bottom:8px;
    font-size:12px;
    cursor: pointer;
    transition: transform 0.05s ease, background 0.08s ease;
  }

  .white{
    width:var(--white-key-width);
    height:var(--white-key-height);
    background: linear-gradient(#fff,#f7f7f7);
    border-radius:6px;
    z-index:1;
    color:#222;
    box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  }
  .white.pressed{ background: linear-gradient(var(--accent), #ffd6e0); color: white; transform: translateY(3px); box-shadow: inset 0 -6px 20px rgba(0,0,0,0.08); }

  .black{
    width:var(--black-key-width);
    height:var(--black-key-height);
    background: linear-gradient(#111,#000);
    color:#fff;
    border-radius:4px;
    z-index:2;
    box-shadow: 0 6px 16px rgba(0,0,0,0.7);
  }
  .black.pressed{ background: linear-gradient(var(--accent), #b11f3f); transform: translateY(4px); }

  .note-label{
    font-size:11px;
    opacity:0.9;
    padding:2px 6px;
    border-radius:4px;
    background: rgba(255,255,255,0.0);
    pointer-events:none;
  }

  .info{
    font-size:13px;
    opacity:0.95;
  }

  .small{
    font-size:12px;
    opacity:0.9;
  }

  footer{
    margin-top:8px;
    font-size:12px;
    opacity:0.8;
  }

  /* responsive */
  @media (max-width:900px){
    :root{ --white-key-width:44px; --white-key-height:220px; --black-key-width:28px; --black-key-height:140px; }
  }
  @media (max-width:600px){
    .rotate{ font-size:15px; }
    .personal{ font-size:14px; }
  }
</style>
</head>
<body>
  <div class="notice" role="region" aria-label="Ø±Ø§Ù‡Ù†Ù…Ø§">
    <div class="rotate">ØµÙØ­Ù‡Ù” Ú¯ÙˆØ´ÛŒÙˆ Ø¨Ú†Ø±Ø®ÙˆÙ† ØªØ§ Ù‡Ù…Ù‡Ù” Ú©Ù„Ø§ÙˆÛŒÙ‡â€ŒÙ‡Ø§ Ø¨Ø±Ø§Øª Ø¨ÛŒØ§Ù† â€” <strong>Ø­ØªÙ…Ø§Ù‹ Ú¯ÙˆØ´ÛŒ Ø±Ùˆ Ø§ÙÙ‚ÛŒ Ú©Ù†</strong>.</div>
    <div class="personal">Ù…Ø®ØµÙˆØµ <strong>Ø§Ù†Ø§Ù‡ÛŒØªØ§Ø§Ø§Ø§ Ø¬ÙˆÙ†</strong> â€” Ø¯ÙˆØ³Øª Ù‡Ù†Ø±Ù…Ù†Ø¯ Ù…Ù† ğŸ¨</div>
    <div class="note-line">
      <div>ÛŒØ§Ø¯ØªÙ‡ Ú¯ÙØªÛŒ Ù¾ÛŒØ§Ù†Ùˆ Ø±Ùˆ Ù†Ù…ÛŒØ´Ù‡ Ø¬Ø§ÛŒÛŒ Ø¨Ø±Ø¯ØŸ ÙˆÙ„ÛŒ Ú¯ÙˆØ´ÛŒÙˆ Ú©Ù‡ Ù…ÛŒØªÙˆÙ†ÛŒ. Ø§ÛŒÙ† Ø³Ø§ÛŒØª Ù…Ø®ØµÙˆØµ ØªÙˆ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯ Ú©Ù‡ Ø¨ØªÙˆÙ†ÛŒ Ù¾ÛŒØ§Ù†Ùˆâ€ŒØªÙˆ Ù‡Ø± Ø¬Ø§ Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ø¨Ø±ÛŒ.</div>
      <!-- SVG heart sticker -->
      <svg class="heart" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <defs>
          <linearGradient id="g1" x1="0" x2="1" y1="0" y2="1">
            <stop offset="0" stop-color="#ff6b81"/>
            <stop offset="1" stop-color="#ffb199"/>
          </linearGradient>
        </defs>
        <path fill="url(#g1)" d="M12 21s-7.2-4.6-9.2-7.2C-1.1 8.9 4 3 8.6 6.1 10.4 7.5 12 10 12 10s1.6-2.5 3.4-3.9C20 3 25.1 8.9 21.2 13.8 19.2 16.4 12 21 12 21z"/>
      </svg>
    </div>
  </div>

  <div class="controls" role="group" aria-label="Ú©Ù†ØªØ±Ù„â€ŒÙ‡Ø§">
    <label>Ø­Ø¬Ù…: <input id="volume" type="range" min="0" max="100" value="60" /></label>
    <label>Ø§Ú©ØªØ§Ùˆ (Ø´ÛŒÙØª): 
      <select id="octaveSelect">
        <option value="-2">-2</option>
        <option value="-1">-1</option>
        <option value="0" selected>0</option>
        <option value="1">+1</option>
        <option value="2">+2</option>
      </select>
    </label>
    <label><input id="sustain" type="checkbox" /> Sustain (Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ†)</label>
    <div class="small info">Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø®ØªÙ† Ø¨Ø§ Ú©ÛŒØ¨ÙˆØ±Ø¯: Ø§Ø² Ø±Ø¯ÛŒÙ z/s/x/d/... Ùˆ Ø±Ø¯ÛŒÙ Ø¨Ø§Ù„Ø§ØªØ± Q/2/W/... Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†. (Ù‚Ø§Ø¨Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø±ÙˆÛŒ Ø¯Ø³Ú©ØªØ§Ù¾ Ùˆ Ù…ÙˆØ¨Ø§ÛŒÙ„)</div>
  </div>

  <div class="keyboard-wrap" id="wrap" aria-hidden="false">
    <div class="keyboard" id="keyboard" tabindex="0"></div>
  </div>

  <footer class="small">Ø±Ø§Ù‡Ù†Ù…Ø§: Ú©Ù„ÛŒÚ© ÛŒØ§ Ù„Ù…Ø³ Ø¨Ø±Ø§ÛŒ Ù†ÙˆØ§Ø®ØªÙ† â€” Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Sustain ÛŒØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² ØµÙØ­Ù‡â€ŒÚ©Ù„ÛŒØ¯. ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ù‡ Ù†Ø§Ù… <code>index.html</code> Ø°Ø®ÛŒØ±Ù‡ Ú©Ù† Ùˆ Ø¯Ø± Ø±ÛŒØ´Ù‡Ù” repo Ø¢Ù¾Ù„ÙˆØ¯ Ú©Ù† (ÛŒØ§ Ø§Ø² gh-pages Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†).</footer>

<script>
/* Ù¾ÛŒØ§Ù†ÙˆÛŒ Ú©Ø§Ù…Ù„ 88 Ú©Ù„Ø§ÙˆÛŒÙ‡ (MIDI 21..108) Ø¨Ø§ Web Audio
   ØªÙ„Ø§Ø´ Ø´Ø¯Ù‡ Ù‡Ù…Ù‡Ù” Ú©Ù„ÛŒØ¯Ù‡Ø§ Ø¯Ù‚ÛŒÙ‚ Ø³Ø§Ø®ØªÙ‡ Ùˆ Ù…Ø±ØªØ¨ Ø´ÙˆÙ†Ø¯.
*/

const AudioCtx = window.AudioContext || window.webkitAudioContext;
const ctx = new AudioCtx();

// Master chain
const masterGain = ctx.createGain();
masterGain.gain.value = 0.6;
masterGain.connect(ctx.destination);

// Reverb placeholder (simple convolver could be added) - omitted to keep file self-contained and lightweight

// Key definitions (semitone names)
const keysDefinition = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];

function midiToFreq(m){
  // Standard formula
  return 440 * Math.pow(2, (m - 69) / 12);
}

// Full piano range
const startMidi = 21; // A0
const endMidi = 108;  // C8
const totalKeys = endMidi - startMidi + 1; // 88

const keyboardEl = document.getElementById('keyboard');
const keyElements = [];
const activeNotes = new Map(); // midi -> {osc,gain,released,stopTimer}

// Build keys: we will create absolute-positioned keys and compute positions precisely
// First compute white key sequence and positions
const whiteMidiList = [];
for(let m = startMidi; m <= endMidi; m++){
  const name = keysDefinition[(m % 12 + 12) % 12];
  if(!name.includes('#')) whiteMidiList.push(m);
}
const whiteCount = whiteMidiList.length;

// Create elements for all keys and store meta
for(let m = startMidi; m <= endMidi; m++){
  const name = keysDefinition[(m % 12 + 12) % 12];
  const octave = Math.floor(m/12) - 1;
  const label = name + octave;
  const isSharp = name.includes('#');
  const el = document.createElement('div');
  el.className = 'key ' + (isSharp ? 'black' : 'white');
  el.dataset.midi = m;
  el.dataset.note = label;
  el.setAttribute('role','button');
  el.setAttribute('aria-label', label);
  el.innerHTML = '<span class="note-label">' + label + '</span>';
  keyboardEl.appendChild(el);
  keyElements.push({midi:m, el, isSharp});
}

// Layout function: position whites in sequence, then place blacks between them
function layoutKeys(){
  const wrapStyle = getComputedStyle(document.documentElement);
  const whiteW = parseFloat(wrapStyle.getPropertyValue('--white-key-width')) || 56;
  const blackW = parseFloat(wrapStyle.getPropertyValue('--black-key-width')) || 36;
  const gap = parseFloat(wrapStyle.getPropertyValue('--gap')) || 2;

  // Build array of white midi in order
  const whites = keyElements.filter(k=>!k.isSharp).sort((a,b)=>a.midi-b.midi);
  const blacks = keyElements.filter(k=>k.isSharp).sort((a,b)=>a.midi-b.midi);

  // Position whites left-to-right
  whites.forEach((w, idx)=>{
    const left = idx * (whiteW + gap);
    w.el.style.left = left + 'px';
    w.el.style.width = whiteW + 'px';
    w.el.style.height = getComputedStyle(document.documentElement).getPropertyValue('--white-key-height') || '300px';
    w.el.style.position = 'absolute';
  });

  // For blacks: find the white key to the left and position slightly overlapping
  // mapping: black key sits between previous and next white keys. We'll compute by scanning MIDI.
  blacks.forEach(b=>{
    // find index of the white key that is immediately left of this black key
    // count number of white keys with midi < b.midi
    let leftCount = 0;
    for(const w of whites){
      if(w.midi < b.midi) leftCount++;
    }
    // we want to place black roughly at leftCount-1 + offset
    const left = (leftCount - 1) * (whiteW + gap) + whiteW * 0.65;
    b.el.style.left = left + 'px';
    b.el.style.width = blackW + 'px';
    b.el.style.height = getComputedStyle(document.documentElement).getPropertyValue('--black-key-height') || '180px';
    b.el.style.position = 'absolute';
  });

  // set keyboard total width
  const totalWidth = whites.length * (whiteW + gap);
  keyboardEl.style.width = (totalWidth + 12) + 'px';
}
setTimeout(layoutKeys, 60);
window.addEventListener('resize', ()=> setTimeout(layoutKeys, 60));

// Sound engine
function createVoice(midi, velocity=1){
  const osc = ctx.createOscillator();
  // use a blended sound for richer timbre: fundamental + gentle overtone via GainNode + oscillator pair
  const osc2 = ctx.createOscillator();
  const g1 = ctx.createGain();
  const g2 = ctx.createGain();
  const master = ctx.createGain();

  const freq = midiToFreq(midi);
  osc.type = 'sine';
  osc.frequency.value = freq;
  osc2.type = 'sine';
  osc2.frequency.value = freq * 2; // simple harmonic
  g1.gain.value = 1.0;
  g2.gain.value = 0.18; // overtone level
  master.gain.value = velocity * (document.getElementById('volume').value/100);

  osc.connect(g1); g1.connect(master);
  osc2.connect(g2); g2.connect(master);
  master.connect(masterGain);

  const now = ctx.currentTime;
  const attack = 0.01;
  const decay = 0.08;
  const sustainLevel = 0.6;
  master.gain.setValueAtTime(0.0001, now);
  master.gain.linearRampToValueAtTime(1.0 * velocity * (document.getElementById('volume').value/100), now + attack);
  master.gain.linearRampToValueAtTime(sustainLevel * velocity * (document.getElementById('volume').value/100), now + attack + decay);

  osc.start();
  osc2.start();

  return {osc, osc2, g1, g2, master};
}

function playMidi(midi, {velocity=1, sustain=false}={}){
  // if already playing and not released, ignore (or retrigger)
  const existing = activeNotes.get(midi);
  if(existing && !existing.released) return;
  const voice = createVoice(midi, velocity);
  activeNotes.set(midi, {voice, released:false});
  highlightKey(midi, true);
}

function releaseMidi(midi){
  const entry = activeNotes.get(midi);
  if(!entry || entry.released) return;
  const now = ctx.currentTime;
  entry.released = true;
  const releaseTime = 0.45;
  try{
    const master = entry.voice.master;
    master.gain.cancelScheduledValues(now);
    master.gain.setValueAtTime(master.gain.value, now);
    master.gain.linearRampToValueAtTime(0.0001, now + releaseTime);
    // stop oscillators after release fade
    setTimeout(()=>{
      try{ entry.voice.osc.stop(); entry.voice.osc.disconnect(); } catch(e){}
      try{ entry.voice.osc2.stop(); entry.voice.osc2.disconnect(); } catch(e){}
      try{ entry.voice.g1.disconnect(); entry.voice.g2.disconnect(); entry.voice.master.disconnect(); } catch(e){}
      activeNotes.delete(midi);
      highlightKey(midi, false);
    }, (releaseTime + 0.05) * 1000);
  }catch(e){
    activeNotes.delete(midi);
    highlightKey(midi, false);
  }
}

function highlightKey(midi, on){
  const item = keyElements.find(k=>k.midi===midi);
  if(!item) return;
  if(on) item.el.classList.add('pressed'); else item.el.classList.remove('pressed');
}

// Pointer / touch handling
keyboardEl.addEventListener('pointerdown', e=>{
  const k = e.target.closest('.key');
  if(!k) return;
  e.preventDefault();
  ctx.resume();
  const midi = parseInt(k.dataset.midi,10);
  const sustain = document.getElementById('sustain').checked;
  playMidi(midi, {velocity:1, sustain});
  // mark pointer capture to receive pointerup
  k.setPointerCapture && k.setPointerCapture(e.pointerId);
});
keyboardEl.addEventListener('pointerup', e=>{
  const k = e.target.closest('.key');
  if(!k) return;
  const midi = parseInt(k.dataset.midi,10);
  if(!document.getElementById('sustain').checked) releaseMidi(midi);
});
keyboardEl.addEventListener('pointerleave', e=>{
  // on dragging out, release if no sustain
  const k = e.target.closest('.key');
  if(!k) return;
  const midi = parseInt(k.dataset.midi,10);
  if(!document.getElementById('sustain').checked) releaseMidi(midi);
});

// click (tap) short note
keyboardEl.addEventListener('click', e=>{
  const k = e.target.closest('.key');
  if(!k) return;
  const midi = parseInt(k.dataset.midi,10);
  const sustain = document.getElementById('sustain').checked;
  playMidi(midi, {velocity:1, sustain});
  if(!sustain) setTimeout(()=> releaseMidi(midi), 240);
});

// Keyboard mapping (common web-piano mapping). We'll include two rows for comfortable play.
// Mapping base positions to specific MIDI values. For wide range we map starting keys to middle C region and allow octaveShift.
const keyMap = {
  'KeyZ': 48, 'KeyS':49, 'KeyX':50, 'KeyD':51, 'KeyC':52, 'KeyV':53, 'KeyG':54,
  'KeyB':55, 'KeyH':56, 'KeyN':57, 'KeyJ':58, 'KeyM':59, 'Comma':60, 'KeyL':61,
  'Period':62, 'Semicolon':63, 'Slash':64,
  // upper row
  'KeyQ':60, 'Digit2':61, 'KeyW':62, 'Digit3':63, 'KeyE':64, 'KeyR':65, 'Digit5':66,
  'KeyT':67, 'Digit6':68, 'KeyY':69, 'Digit7':70, 'KeyU':71, 'KeyI':72
};

const pressedKeys = new Set();
window.addEventListener('keydown', ev=>{
  if(ev.repeat) return;
  const code = ev.code;
  const base = keyMap[code];
  if(base !== undefined){
    ev.preventDefault();
    pressedKeys.add(code);
    const octaveShift = parseInt(document.getElementById('octaveSelect').value || '0',10);
    const midi = base + octaveShift*12;
    ctx.resume();
    playMidi(midi, {velocity:0.95, sustain: document.getElementById('sustain').checked});
  }
});
window.addEventListener('keyup', ev=>{
  const code = ev.code;
  const base = keyMap[code];
  if(base !== undefined){
    ev.preventDefault();
    pressedKeys.delete(code);
    const octaveShift = parseInt(document.getElementById('octaveSelect').value || '0',10);
    const midi = base + octaveShift*12;
    if(!document.getElementById('sustain').checked) releaseMidi(midi);
  }
});

// Volume control
document.getElementById('volume').addEventListener('input', e=>{
  const val = parseFloat(e.target.value)/100;
  masterGain.gain.cancelScheduledValues(ctx.currentTime);
  masterGain.gain.linearRampToValueAtTime(val, ctx.currentTime + 0.02);
});

// Sustain toggle: when turned off, release all held notes
document.getElementById('sustain').addEventListener('change', e=>{
  if(!e.target.checked){
    for(const [m,entry] of activeNotes.entries()){
      if(!entry.released) releaseMidi(m);
    }
  }
});

// Accessibility: focus into keyboard for keyboard users
keyboardEl.addEventListener('focus', ()=> {
  // hint could be added
});

// Initialize layout again after fonts/resize
setTimeout(layoutKeys, 120);

</script>
</body>
</html>
